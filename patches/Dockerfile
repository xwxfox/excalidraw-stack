FROM node:18 AS build

WORKDIR /opt/node_app

# Copy the entire app
COPY . .

# Define all build-time arguments
ARG NODE_ENV
ARG VITE_APP_BACKEND_V2_GET_URL
ARG VITE_APP_BACKEND_V2_POST_URL
ARG VITE_APP_LIBRARY_URL
ARG VITE_APP_LIBRARY_BACKEND
ARG VITE_APP_PLUS_LP
ARG VITE_APP_PLUS_APP
ARG VITE_APP_AI_BACKEND
ARG VITE_APP_WS_SERVER_URL
ARG VITE_APP_FIREBASE_CONFIG
ARG VITE_APP_HTTP_STORAGE_BACKEND_URL
ARG VITE_APP_STORAGE_BACKEND
ARG VITE_APP_ENABLE_TRACKING
ARG PUBLIC_URL
ARG VITE_APP_DEV_DISABLE_LIVE_RELOAD
ARG VITE_APP_PLUS_EXPORT_PUBLIC_KEY
ARG VITE_APP_DEBUG_ENABLE_TEXT_CONTAINER_BOUNDING_BOX
ARG VITE_APP_COLLAPSE_OVERLAY
ARG VITE_APP_ENABLE_ESLINT
ARG FAST_REFRESH
ARG VITE_APP_ENABLE_PWA

ENV NODE_ENV=${NODE_ENV}
ENV VITE_APP_BACKEND_V2_GET_URL=${VITE_APP_BACKEND_V2_GET_URL}
ENV VITE_APP_BACKEND_V2_POST_URL=${VITE_APP_BACKEND_V2_POST_URL}
ENV VITE_APP_LIBRARY_URL=${VITE_APP_LIBRARY_URL}
ENV VITE_APP_LIBRARY_BACKEND=${VITE_APP_LIBRARY_BACKEND}
ENV VITE_APP_PLUS_LP=${VITE_APP_PLUS_LP}
ENV VITE_APP_PLUS_APP=${VITE_APP_PLUS_APP}
ENV VITE_APP_AI_BACKEND=${VITE_APP_AI_BACKEND}
ENV VITE_APP_WS_SERVER_URL=${VITE_APP_WS_SERVER_URL}
ENV VITE_APP_FIREBASE_CONFIG=${VITE_APP_FIREBASE_CONFIG}
ENV VITE_APP_HTTP_STORAGE_BACKEND_URL=${VITE_APP_HTTP_STORAGE_BACKEND_URL}
ENV VITE_APP_STORAGE_BACKEND=${VITE_APP_STORAGE_BACKEND}
ENV VITE_APP_ENABLE_TRACKING=${VITE_APP_ENABLE_TRACKING}
ENV PUBLIC_URL=${PUBLIC_URL}
ENV VITE_APP_DEV_DISABLE_LIVE_RELOAD=${VITE_APP_DEV_DISABLE_LIVE_RELOAD}
ENV VITE_APP_PLUS_EXPORT_PUBLIC_KEY=${VITE_APP_PLUS_EXPORT_PUBLIC_KEY}
ENV VITE_APP_DEBUG_ENABLE_TEXT_CONTAINER_BOUNDING_BOX=${VITE_APP_DEBUG_ENABLE_TEXT_CONTAINER_BOUNDING_BOX}
ENV VITE_APP_COLLAPSE_OVERLAY=${VITE_APP_COLLAPSE_OVERLAY}
ENV VITE_APP_ENABLE_ESLINT=${VITE_APP_ENABLE_ESLINT}
ENV FAST_REFRESH=${FAST_REFRESH}
ENV VITE_APP_ENABLE_PWA=${VITE_APP_ENABLE_PWA}

# Install dependencies
RUN yarn --network-timeout 600000

# Build app
RUN yarn build:app:docker

# ────────────────────────────────
# Runtime image
# ────────────────────────────────
FROM nginx:1.27-alpine

ENV VITE_APP_BACKEND_V2_GET_URL=${VITE_APP_BACKEND_V2_GET_URL}
ENV VITE_APP_BACKEND_V2_POST_URL=${VITE_APP_BACKEND_V2_POST_URL}
ENV VITE_APP_LIBRARY_URL=${VITE_APP_LIBRARY_URL}
ENV VITE_APP_LIBRARY_BACKEND=${VITE_APP_LIBRARY_BACKEND}
ENV VITE_APP_PLUS_LP=${VITE_APP_PLUS_LP}
ENV VITE_APP_PLUS_APP=${VITE_APP_PLUS_APP}
ENV VITE_APP_AI_BACKEND=${VITE_APP_AI_BACKEND}
ENV VITE_APP_WS_SERVER_URL=${VITE_APP_WS_SERVER_URL}
ENV VITE_APP_FIREBASE_CONFIG=${VITE_APP_FIREBASE_CONFIG}
ENV VITE_APP_HTTP_STORAGE_BACKEND_URL=${VITE_APP_HTTP_STORAGE_BACKEND_URL}
ENV VITE_APP_STORAGE_BACKEND=${VITE_APP_STORAGE_BACKEND}
ENV VITE_APP_ENABLE_TRACKING=${VITE_APP_ENABLE_TRACKING}
ENV PUBLIC_URL=${PUBLIC_URL}
ENV VITE_APP_DEV_DISABLE_LIVE_RELOAD=${VITE_APP_DEV_DISABLE_LIVE_RELOAD}
ENV VITE_APP_PLUS_EXPORT_PUBLIC_KEY=${VITE_APP_PLUS_EXPORT_PUBLIC_KEY}
ENV VITE_APP_DEBUG_ENABLE_TEXT_CONTAINER_BOUNDING_BOX=${VITE_APP_DEBUG_ENABLE_TEXT_CONTAINER_BOUNDING_BOX}
ENV VITE_APP_COLLAPSE_OVERLAY=${VITE_APP_COLLAPSE_OVERLAY}
ENV VITE_APP_ENABLE_ESLINT=${VITE_APP_ENABLE_ESLINT}
ENV FAST_REFRESH=${FAST_REFRESH}
ENV VITE_APP_ENABLE_PWA=${VITE_APP_ENABLE_PWA}

# Copy build output from previous stage
COPY --from=build /opt/node_app/excalidraw-app/build /usr/share/nginx/html

# This was from back when we needed to patch the build output
# to replace hardcoded backend URLs with env vars at runtime.
# We dont use it anymore, but leaving it here for now in case we need it again.
# COPY patch.ts /opt/node_app/patch.ts

# RUN npx -y tsx patch.ts --verbose --dir /opt/node_app/excalidraw-app/build

# Healthcheck and port
HEALTHCHECK CMD wget -q -O /dev/null http://localhost || exit 1
EXPOSE 80

